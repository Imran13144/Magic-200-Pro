<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic 200 Board Game 3D - Realistic Pro Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root {
            --red: #ff5252; --blue: #448aff; --green: #4caf50; --yellow: #ffd740;
            --orange: #ffab40; --pink: #ff4081; --purple: #e040fb; --cyan: #18ffff;
            --lgreen: #b2ff59; --skyblue: #40c4ff;
            --magic-glow: rgba(224, 64, 251, 0.6);
            --glass: rgba(255, 255, 255, 0.85);
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle, #455a64 0%, #263238 100%);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* --- MODERN HEADER --- */
        header {
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 3000;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        
        .menu-toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333;
            display: flex; align-items: center; justify-content: center;
        }

        .profile-btn {
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; background: rgba(0,0,0,0.05); padding: 6px 18px;
            border-radius: 50px; border: 1.5px solid #448aff;
            transition: 0.3s;
        }
        .profile-btn:hover { background: rgba(68, 138, 255, 0.1); }
        
        .avatar-circle {
            width: 35px; height: 35px; border-radius: 50%;
            object-fit: cover; border: 2px solid white; background: #eee;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        #user-name-disp { font-weight: 600; color: #333; }

        /* --- SIDEBAR --- */
        #sidebar {
            position: fixed; left: calc(-1 * var(--sidebar-width)); top: 0;
            width: var(--sidebar-width); height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            z-index: 4000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; padding: 25px;
            color: #333;
        }
        #sidebar.active { left: 0; }
        .sidebar-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;
        }
        .sidebar-item {
            padding: 15px; margin: 5px 0; border-radius: 12px;
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .sidebar-item:hover { background: rgba(68, 138, 255, 0.1); color: var(--blue); }
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 3500; display: none; opacity: 0; transition: 0.3s;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- MENUS & OVERLAYS --- */
        #menu, .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; backdrop-filter: blur(8px);
        }
        .menu-title { 
            font-size: 3rem; color: white; margin-bottom: 2rem; 
            text-shadow: 0 0 20px var(--blue); font-weight: 900;
        }
        
        .menu-btn {
            padding: 16px 45px; margin: 12px; font-size: 1.2rem;
            border: none; border-radius: 15px; cursor: pointer;
            background: linear-gradient(135deg, var(--blue), var(--skyblue));
            color: white; transition: 0.4s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            width: 100%; max-width: 300px; font-weight: 600;
            position: relative;
        }
        .menu-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(68,138,255,0.5); }
        .menu-btn:disabled { background: #555 !important; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .online-tag {
            position: absolute; top: -10px; right: -10px;
            background: #4caf50; color: white; font-size: 0.7rem;
            padding: 2px 8px; border-radius: 10px; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .online-tag.offline { background: #e74c3c; }

        #offline-setup, #profile-modal, #signup-page, #login-page { display: none; z-index: 5000; }
        .setup-card { 
            background: white; padding: 30px; border-radius: 25px; 
            width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }
        .setup-card input[type="text"], .setup-card input[type="number"], .setup-card input[type="password"] { 
            width: 100%; padding: 12px; margin: 10px 0; 
            border: 2px solid #eee; border-radius: 12px; font-size: 1rem;
        }
        
        .pass-container { position: relative; }
        .toggle-pass { position: absolute; right: 15px; top: 22px; cursor: pointer; font-size: 1.2rem; }

        .image-upload-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px;
        }
        #profile-preview {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--blue);
        }
        .custom-file-upload {
            background: #eee; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
        }

        /* --- REALISTIC BOARD LAYOUT --- */
        #game-container {
            flex: 1; position: relative; overflow: hidden;
            display: none; align-items: center; justify-content: center;
            perspective: 1500px;
        }
        #board-wrapper { 
            transition: transform 0.1s ease-out; 
            transform-style: preserve-3d; 
            position: absolute;
            box-shadow: 0 50px 100px rgba(0,0,0,0.5);
        }
        #board {
            display: grid; grid-template-columns: repeat(10, 65px); grid-template-rows: repeat(20, 65px);
            background: #2c3e50; border: 10px solid #ecf0f1; border-radius: 8px;
            position: relative; transform-style: preserve-3d;
        }

        .box {
            width: 65px; height: 65px; border: 0.5px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: rgba(255,255,255,0.9); 
            font-size: 1rem; position: relative;
            background-blend-mode: overlay;
            background-image: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.1));
            text-shadow: 1px 1px 0px #000, 2px 2px 0px rgba(0,0,0,0.5), 3px 3px 5px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }

        #game-svg {
            position: absolute; top: 0; left: 0;
            width: 650px; height: 1300px;
            pointer-events: none; z-index: 50;
        }

        .portal-tile { 
            background: var(--magic-glow) !important; 
            animation: portal-anim 3s infinite ease-in-out; 
        }
        @keyframes portal-anim {
            0%, 100% { box-shadow: inset 0 0 10px #fff; opacity: 0.8; }
            50% { box-shadow: inset 0 0 30px #fff; opacity: 1; }
        }

        .finish-box {
            background: linear-gradient(45deg, #ff5252, #448aff, #4caf50, #ffd740, #ffab40, #ff4081, #e040fb, #18ffff, #b2ff59, #40c4ff) !important;
            background-size: 400% 400% !important;
            animation: finish-glow 5s linear infinite;
            border: 4px solid gold !important;
            z-index: 10;
            color: white !important;
            font-size: 1.2rem !important;
            box-shadow: 0 0 25px gold;
        }
        @keyframes finish-glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .snake-path {
            animation: slither 3s infinite ease-in-out;
            transform-origin: center;
        }
        @keyframes slither {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.02) rotate(1.4deg); }
        }

        /* SNAKE EYE ANIMATION */
        .snake-eye {
            animation: blink 4s infinite;
        }
        @keyframes blink {
            0%, 92%, 100% { opacity: 1; filter: brightness(1.5); }
            96% { opacity: 0.1; filter: brightness(0.5); }
        }

        .token {
            width: 35px; height: 35px; position: absolute; z-index: 100;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d; pointer-events: none;
        }
        .horse { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; }
        .horse-body { 
            width: 20px; height: 35px; background: white; border-radius: 10px 10px 2px 2px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); border: 2px solid rgba(0,0,0,0.1);
            background-size: cover; background-position: center;
        }
        .horse-base { 
            width: 28px; height: 8px; background: rgba(0,0,0,0.5); 
            border-radius: 50%; position: absolute; bottom: -5px; filter: blur(2px);
        }

        .side-btns {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 1500;
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 20px;
            backdrop-filter: blur(5px);
        }
        .ui-btn {
            width: 60px; height: 60px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.3);
            background: var(--glass); backdrop-filter: blur(10px); color: #333; font-size: 1.6rem; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .ui-btn:active { transform: scale(0.9); }
        
        .volume-container {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        #vol-slider {
            writing-mode: bt-lr; 
            appearance: slider-vertical;
            width: 10px; height: 100px;
        }

        #bottom-panel {
            height: 140px; background: var(--glass); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 20px; z-index: 1600;
        }

        .dice-area { width: 80px; height: 80px; perspective: 1000px; cursor: pointer; }
        .dice {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dice-face {
            position: absolute; width: 80px; height: 80px;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; font-weight: bold; color: white;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            backface-visibility: hidden;
        }
        .f1 { transform: rotateY(0deg) translateZ(40px); background: #e74c3c; }
        .f2 { transform: rotateY(90deg) translateZ(40px); background: #3498db; }
        .f3 { transform: rotateY(180deg) translateZ(40px); background: #2ecc71; }
        .f4 { transform: rotateY(-90deg) translateZ(40px); background: #f1c40f; color: #333; }
        .f5 { transform: rotateX(90deg) translateZ(40px); background: #e67e22; }
        .f6 { transform: rotateX(-90deg) translateZ(40px); background: #9b59b6; }

        #win-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }

        #fireworks-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2900;
        }

        @media (max-width: 600px) {
            #board { grid-template-columns: repeat(10, 42px); grid-template-rows: repeat(20, 42px); }
            .box { width: 42px; height: 42px; font-size: 0.7rem; }
            #game-svg { width: 420px; height: 840px; }
            .dice-area { width: 60px; height: 60px; }
            .dice-face { width: 60px; height: 60px; font-size: 1.5rem; }
            /* Mobile depth adjustment */
            .f1 { transform: rotateY(0deg) translateZ(30px); }
            .f2 { transform: rotateY(90deg) translateZ(30px); }
            .f3 { transform: rotateY(180deg) translateZ(30px); }
            .f4 { transform: rotateY(-90deg) translateZ(30px); }
            .f5 { transform: rotateX(90deg) translateZ(30px); }
            .f6 { transform: rotateX(-90deg) translateZ(30px); }
        }

        .coin-btn {
            background: #eee; border: 2px solid #ddd; padding: 10px; border-radius: 10px; 
            cursor: pointer; font-weight: bold; font-size: 1rem;
        }
        .coin-btn.selected { background: #ffd740; border-color: orange; }

        /* ADDED: Ticker & History Styles */
        #top-ticker {
            position: fixed; top: 0; left: 0; width: 100%; height: 35px;
            background: rgba(0,0,0,0.8); color: gold; z-index: 6000;
            display: flex; align-items: center; overflow: hidden;
            font-weight: 800; border-bottom: 2px solid gold;
        }
        #ticker-content {
            white-space: nowrap; animation: ticker-move 15s linear infinite;
            padding-left: 100%; font-size: 0.9rem;
        }
        @keyframes ticker-move {
            0% { transform: translateX(0); }
            100% { transform: translateX(-200%); }
        }
        #history-panel { margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 15px; max-height: 200px; overflow-y: auto; text-align: left; }
        .history-item { padding: 5px 10px; border-bottom: 1px solid #ddd; font-size: 0.85rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body onload="initApp()">

    <div id="top-ticker"><div id="ticker-content">Waiting for Champions...</div></div>

    <div id="signup-page" class="modal-overlay" style="display: flex;">
        <div class="setup-card">
            <h2 style="color:#333">Create Account</h2>
            <input type="text" id="reg-name" placeholder="Full Name">
            <input type="number" id="reg-phone" placeholder="Phone Number">
            <div class="pass-container">
                <input type="password" id="reg-pass" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassVisibility('reg-pass')">üëÅÔ∏è</span>
            </div>
            <button class="menu-btn" onclick="handleSignup()">SUBMIT</button>
            <p style="color:#666; font-size: 0.9rem; margin-top: 15px;">
                Already registered? <span style="color:var(--blue); cursor:pointer; font-weight:bold;" onclick="switchAuth('login')">Login</span>
            </p>
        </div>
    </div>

    <div id="login-page" class="modal-overlay">
        <div class="setup-card">
            <h2 style="color:#333">Login</h2>
            <input type="number" id="log-phone" placeholder="Phone Number">
            <div class="pass-container">
                <input type="password" id="log-pass" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassVisibility('log-pass')">üëÅÔ∏è</span>
            </div>
            <button class="menu-btn" onclick="handleLogin()">LOGIN</button>
            <p style="color:#666; font-size: 0.9rem; margin-top: 15px;">
                New user? <span style="color:var(--blue); cursor:pointer; font-weight:bold;" onclick="switchAuth('signup')">Sign Up</span>
            </p>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; color:var(--blue);">Game Menu</h2>
            <button class="menu-toggle-btn" onclick="toggleSidebar()">‚úï</button>
        </div>
        
        <div class="sidebar-item" onclick="forceQuit()">
            <span>üè†</span> Home
        </div>
        <div class="sidebar-item" onclick="openProfile()">
            <span>üë§</span> Change Photo / Profile
        </div>
        <div class="sidebar-item" onclick="referGame()">
            <span>üéÅ</span> Refer
        </div>
        <div class="sidebar-item" onclick="shareGame()">
            <span>üì§</span> Share
        </div>
        <div class="sidebar-item" onclick="alert('Magic 200 Rules:\n1. Roll dice to move.\n2. Ladders take you UP.\n3. Snakes take you DOWN.\n4. Magic Portals teleport you randomly!\n5. Landing on opponent sends them to 1!')">
            <span>üìú</span> Game Rules
        </div>
        <div class="sidebar-item" onclick="contactSupport()">
            <span>üéß</span> Help and Support
        </div>
        
        <div class="sidebar-item" onclick="alert('Version 3.0.1 Pro Edition\nCreated for ultimate fun!')">
            <span>‚Ñπ</span> About Game
        </div>

        <div class="sidebar-item" onclick="logoutUser()" style="color: #e74c3c; font-weight: bold;">
            <span>üö™</span> Logout
        </div>
        
        <div class="sidebar-item" onclick="location.reload()" style="margin-top: auto; border-top: 1px solid #eee;">
            <span>üîÑ</span> Restart
        </div>
    </aside>

    <header id="main-header" style="display: none; margin-top: 35px;">
        <div class="header-left">
            <button class="menu-toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div class="logo" style="font-weight: 900; color: var(--blue); font-size: 1.4rem; letter-spacing: 1px;">MAGIC 200 PRO</div>
        </div>
        
        <div></div>

        <div class="profile-btn" onclick="openProfile()">
            <img id="user-avatar-disp" class="avatar-circle" src="" alt="üë§" onerror="this.style.display='none'">
            <span id="user-name-disp">Guest Player</span>
        </div>
    </header>

    <div id="menu" style="display: none;">
        <h1 class="menu-title">Magic 200</h1>
        <button class="menu-btn" id="global-match-btn" onclick="startSoloMode()">
            üåê GLOBAL MATCH (MULTI)
            <span class="online-tag" id="online-count">Checking...</span>
        </button>
        <button class="menu-btn" onclick="startMode('vs')">ü§ñ VS COMPUTER</button>
        <button class="menu-btn" onclick="showOfflineSetup()">üë• LOCAL MULTIPLAYER</button>
        
        <div id="history-panel">
            <h4 style="margin:0 0 10px 0; color:#333;">Win History</h4>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="setup-card">
            <h2 style="color:#333">Edit Profile</h2>
            
            <div class="image-upload-wrapper">
                <img id="profile-preview" src="https://via.placeholder.com/80" alt="Preview">
                <label class="custom-file-upload">
                    <input type="file" id="profile-image-input" accept="image/*" style="display:none;" onchange="previewImage(this)">
                    Choose Photo
                </label>
            </div>

            <input type="text" id="profile-name" placeholder="Your Name">
            
            <button class="menu-btn" onclick="saveProfile()">SAVE CHANGES</button>
            <button class="menu-btn" style="background:#ccc; color:#333" onclick="document.getElementById('profile-modal').style.display='none'">CANCEL</button>
        </div>
    </div>

    <div id="offline-setup" class="modal-overlay">
        <div class="setup-card" id="step-1">
            <h2 style="color:#333">How many players?</h2>
            <input type="number" id="player-count" min="2" max="6" value="2">
            <button class="menu-btn" onclick="setupNames()">CONTINUE</button>
            <button class="menu-btn" style="background: #ccc; color: #333;" onclick="hideOfflineSetup()">BACK</button>
        </div>
        <div class="setup-card" id="step-2" style="display:none;">
            <h2 style="color:#333">Player Names</h2>
            <div id="name-inputs-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
            <button class="menu-btn" onclick="startOfflineGame()">START ADVENTURE</button>
            <button class="menu-btn" style="background: #ccc; color: #333;" onclick="backToStep1()">BACK</button>
        </div>
    </div>

    <div id="game-container">
        <div id="board-wrapper">
            <div id="board"></div>
            <svg id="game-svg">
                <defs id="snake-defs">
                    <pattern id="pythonPatternBase" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                        <circle cx="20" cy="20" r="12" fill="rgba(0,0,0,0.3)" />
                    </pattern>
                </defs>
            </svg>
            <div id="tokens-layer"></div>
        </div>
    </div>

    <div class="side-btns" id="game-controls" style="display:none">
        <button class="ui-btn" id="sfx-toggle">üîä</button>
        <div class="volume-container">
            <span style="font-size: 0.8rem; color: white;">Music</span>
            <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.2">
        </div>
        <button class="ui-btn" id="zoom-in-btn">‚ûï</button>
        <button class="ui-btn" id="zoom-out-btn">‚ûñ</button>
        <button class="ui-btn" onclick="quitToMenu()" style="color: #e74c3c;">üè†</button>
    </div>

    <div id="bottom-panel" style="display:none">
        <div style="text-align:left; min-width: 120px;">
            <div id="room-id-label" style="font-size: 0.7rem; color: #777; font-weight: bold;"></div>
            <div id="turn-label" style="font-weight:800; color:var(--blue); font-size:1.1rem;">Player 1</div>
            <div id="status-msg" style="font-size:0.85rem; color:#555; font-weight: 500;">Ready to roll?</div>
        </div>
        
        <div class="dice-area" id="dice-trigger">
            <div class="dice" id="dice">
                <div class="dice-face f1">1</div>
                <div class="dice-face f2">2</div>
                <div class="dice-face f3">3</div>
                <div class="dice-face f4">4</div>
                <div class="dice-face f5">5</div>
                <div class="dice-face f6">6</div>
            </div>
        </div>

        <button id="host-restart-btn" class="ui-btn" onclick="handleHostRestart()" style="font-size: 1.2rem; display:none;">üîÑ</button>
    </div>

    <div id="win-overlay">
        <canvas id="fireworks-canvas"></canvas>
        <h1 id="win-msg" style="font-size: 3rem; text-shadow: 0 0 200 gold; z-index: 3100;">VICTORY!</h1>
        <button class="menu-btn" onclick="location.reload()" style="z-index: 3100;">HOME PAGE</button>
    </div>

    <audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>

    <script>
        // --- CONFIG & GLOBAL STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAqOJp30w7TEMXG8oHUmMTDpOy8BjboDY",
            databaseURL:"https://gameadda-48c68-default-rtdb.firebaseio.com"
        };

        const CONFIG = {
            apiKey: "AIzaSyAAqOJp30w7TEMXG8oHUmMTDpOy8BjboDY",
            colors: ['#448aff', '#ff5252', '#4caf50', '#ffd740', '#ffab40', '#e040fb', '#ff4081', '#18ffff', '#b2ff59', '#40c4ff'],
            maxPlayersPerRoom: 10
        };

        let currentPlayerIndex = 0;
        let players = []; 
        let isMoving = false;
        let zoom = 0.8;
        let sfxOn = true;
        let magicPortals = [], snakes = {}, ladders = {};
        let translateX = 0, translateY = 0, isDragging = false, startX, startY;
        let totalDiceRotation = 0;
        let userProfileData = { name: "Guest Player", photo: "", coins: 1000, phone: "", password: "", winCount: 0 };
        let activeMovementTimeout = null;
        let isGlobalMatch = false;
        let isHost = false;
        let isWaitingForRestart = false;
        let selectedBet = 100;
        let currentRoomId = null;
        let roomPlayersList = [];
        let maxPlayersTarget = 2;
        let lastSyncedRollId = null;

        const soundEffects = {
            roll: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            move: new Audio('https://assets.mixkit.co/active_storage/sfx/1113/1113-preview.mp3'),
            win: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            snake: new Audio('https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3'),
            ladder: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3')
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        function initApp() {
            const loggedIn = localStorage.getItem('magic200_logged_in');
            if (loggedIn === 'true') {
                showGameMenu();
                loadSavedProfile();
                updateHistoryUI();
                updateLeaderTicker();
            } else {
                switchAuth('signup');
            }
            updateOnlineStatus();
            setInterval(updateOnlineStatus, 5000);
            db.ref('global_leader').on('value', updateLeaderTicker); // Real-time sync for everyone
        }

        function switchAuth(type) {
            document.getElementById('signup-page').style.display = (type === 'signup') ? 'flex' : 'none';
            document.getElementById('login-page').style.display = (type === 'login') ? 'flex' : 'none';
        }

        function togglePassVisibility(id) {
            const input = document.getElementById(id);
            input.type = (input.type === 'password') ? 'text' : 'password';
        }

        function handleSignup() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();

            if (!name || !phone || !pass) { alert("Please fill all fields"); return; }

            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            if (users.find(u => u.phone === phone)) {
                alert("Already Registered this number!");
                return;
            }

            const newUser = { name, phone, password: pass, coins: 1000, photo: "", winCount: 0 };
            users.push(newUser);
            localStorage.setItem('magic200_users', JSON.stringify(users));
            alert("Signup successful! Please Login.");
            switchAuth('login');
        }

        function handleLogin() {
            const phone = document.getElementById('log-phone').value.trim();
            const pass = document.getElementById('log-pass').value.trim();

            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            const user = users.find(u => u.phone === phone && u.password === pass);

            if (user) {
                userProfileData = user;
                localStorage.setItem('magic200_profile', JSON.stringify(user));
                localStorage.setItem('magic200_logged_in', 'true');
                showGameMenu();
                loadSavedProfile();
                updateHistoryUI();
                updateLeaderTicker();
            } else {
                alert("Invalid number or password!");
            }
        }

        function showGameMenu() {
            document.getElementById('signup-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('menu').style.display = 'flex';
        }

        function logoutUser() {
            if(confirm("Are you sure you want to logout?")) {
                localStorage.setItem('magic200_logged_in', 'false');
                location.reload();
            }
        }

        function updateOnlineStatus() {
            const el = document.getElementById('online-count');
            const btn = document.getElementById('global-match-btn');
            
            if (navigator.onLine) {
                const count = Math.floor(800 + Math.random() * 200);
                el.innerText = count.toLocaleString() + " Online";
                el.classList.remove('offline');
                btn.disabled = false;
                btn.style.opacity = "1";
            } else {
                el.innerText = "OFFLINE";
                el.classList.add('offline');
                btn.disabled = true;
                btn.style.opacity = "0.6";
            }
        }

        function startSoloMode() {
            isGlobalMatch = false;
            players = [
                { name: userProfileData.name, pos: 1, color: CONFIG.colors[0], isBot: false, photo: userProfileData.photo, active: true, phone: userProfileData.phone }
            ];
            initGame();
        }

        function loadSavedProfile() {
            const saved = localStorage.getItem('magic200_profile');
            if(saved) {
                userProfileData = JSON.parse(saved);
                document.getElementById('user-name-disp').innerText = userProfileData.name;
                document.getElementById('profile-name').value = userProfileData.name;
                if(userProfileData.photo) {
                    const avatar = document.getElementById('user-avatar-disp');
                    avatar.src = userProfileData.photo;
                    avatar.style.display = 'block';
                    document.getElementById('profile-preview').src = userProfileData.photo;
                }
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-preview').src = e.target.result;
                    userProfileData.photo = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const nameInput = document.getElementById('profile-name').value.trim();
            if(nameInput) userProfileData.name = nameInput;
            localStorage.setItem('magic200_profile', JSON.stringify(userProfileData));
            
            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            let index = users.findIndex(u => u.phone === userProfileData.phone);
            if (index !== -1) { users[index] = userProfileData; localStorage.setItem('magic200_users', JSON.stringify(users)); }

            document.getElementById('user-name-disp').innerText = userProfileData.name;
            const avatar = document.getElementById('user-avatar-disp');
            if(userProfileData.photo) {
                avatar.src = userProfileData.photo;
                avatar.style.display = 'block';
            }
            document.getElementById('profile-modal').style.display = 'none';
        }

        document.getElementById('dice-trigger').addEventListener('click', handleRoll);
        document.getElementById('zoom-in-btn').addEventListener('click', () => adjustZoom(0.15));
        document.getElementById('zoom-out-btn').addEventListener('click', () => adjustZoom(-0.15));
        
        const volSlider = document.getElementById('vol-slider');
        const bgMusic = document.getElementById('bg-music');
        volSlider.addEventListener('input', (e) => {
            bgMusic.volume = e.target.value;
            if (bgMusic.paused && e.target.value > 0) bgMusic.play().catch(()=>{});
        });

        const sfxBtn = document.getElementById('sfx-toggle');
        sfxBtn.addEventListener('click', () => {
            sfxOn = !sfxOn;
            sfxBtn.innerText = sfxOn ? "üîä" : "üîá";
            sfxBtn.style.opacity = sfxOn ? "1" : "0.5";
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function openProfile() { 
            document.getElementById('profile-modal').style.display = 'flex'; 
            document.getElementById('profile-name').value = userProfileData.name;
            if(userProfileData.photo) document.getElementById('profile-preview').src = userProfileData.photo;
            if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        }

        function referGame() {
            const code = "MAGIC" + Math.floor(1000 + Math.random() * 9000);
            alert("Your Referral Code: " + code + "\nShare this with friends to earn magic coins!");
        }

        function shareGame() {
            const shareUrl = "https://imran13144.github.io/Tic-Tac-Toe-Dawnload/";
            const shareTitle = "Magic 200 Pro - Ultimate 3D Board Game";
            const shareText = "Hey! Play this amazing Magic 200 Board Game with me. Download/Play here:";
            try {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
            } catch (err) {}
            if (navigator.share) {
                navigator.share({ title: shareTitle, text: shareText, url: shareUrl }).catch(() => {});
            } else {
                alert("Game Link Copied to Clipboard!\n" + shareUrl);
            }
        }

        function contactSupport() {
            alert("Help & Support:\nEmail: support@magic200pro.com\nWe are available 24/7 for your help!");
        }

        function startMode(mode) {
            isGlobalMatch = false;
            if(mode === 'vs') {
                players = [
                    { name: userProfileData.name, pos: 1, color: CONFIG.colors[0], isBot: false, photo: userProfileData.photo, active: true, phone: userProfileData.phone },
                    { name: "CPU AI", pos: 1, color: CONFIG.colors[1], isBot: true, photo: "", active: true }
                ];
            }
            initGame();
        }

        function showOfflineSetup() { document.getElementById('offline-setup').style.display = 'flex'; }
        function hideOfflineSetup() { document.getElementById('offline-setup').style.display = 'none'; }
        function backToStep1() {
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-1').style.display = 'block';
        }

        function setupNames() {
            const count = Math.min(Math.max(parseInt(document.getElementById('player-count').value), 2), 6);
            const list = document.getElementById('name-inputs-list');
            list.innerHTML = "";
            for(let i=1; i<=count; i++) {
                let defaultVal = (i===1) ? userProfileData.name : `Player ${i}`;
                list.innerHTML += `<input type="text" id="pname-${i}" placeholder="Player ${i} Name" value="${defaultVal}">`;
            }
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
        }

        function startOfflineGame() {
            const count = parseInt(document.getElementById('player-count').value);
            players = [];
            isGlobalMatch = false;
            for(let i=1; i<=count; i++) {
                let n = document.getElementById(`pname-${i}`).value.trim() || `Player ${i}`;
                let photo = (i === 1) ? userProfileData.photo : "";
                players.push({ name: n, pos: 1, color: CONFIG.colors[(i-1)%CONFIG.colors.length], isBot: false, photo: photo, active: true });
            }
            initGame();
        }

        function initGame() {
            document.getElementById('main-header').style.display = 'none'; 
            document.getElementById('menu').style.display = 'none';
            document.getElementById('offline-setup').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('game-controls').style.display = 'flex';
            document.getElementById('bottom-panel').style.display = 'flex';
            
            generateBoard();
            generateSpecialTiles();
            createTokens();
            updateTurnLabel();
            updateTokensUI();
            bgMusic.volume = volSlider.value;
            bgMusic.play().catch(()=>{});
            setupPanning();
            
            zoom = (window.innerWidth < 600) ? 0.6 : 0.85;
            applyTransform();
            setTimeout(drawLaddersAndSnakes, 600);
        }

        function forceQuit() {
            location.href = location.href; 
        }

        function quitToMenu() { if(confirm("Are you sure you want to quit?")) forceQuit(); }

        function generateBoard() {
            const board = document.getElementById('board');
            board.innerHTML = "";
            for (let row = 19; row >= 0; row--) {
                for (let col = 0; col < 10; col++) {
                    let num = (row % 2 === 0) ? (row * 10) + (10 - col) : (row * 10) + (col + 1);
                    const box = document.createElement('div');
                    box.id = `box-${num}`;
                    box.className = 'box';
                    box.style.background = (num % 2 === 0) ? 'rgba(255,255,255,0.05)' : 'transparent';
                    box.innerText = num;
                    box.style.order = (19 - row) * 10 + col;
                    if(num === 200) { box.classList.add('finish-box'); box.innerText = "üèÜ 200"; }
                    board.appendChild(box);
                }
            }
        }

        function generateSpecialTiles() {
            ladders = { 3: 22, 15: 44, 28: 84, 50: 91, 78: 122, 105: 146, 120: 180, 150: 192 };
            snakes = { 25: 5, 48: 12, 62: 18, 98: 70, 130: 101, 160: 140, 188: 152, 197: 165 };
            magicPortals = [];
            while(magicPortals.length < 10) {
                let p = Math.floor(Math.random()*185)+10;
                if(!ladders[p] && !snakes[p] && !magicPortals.includes(p) && p !== 200) {
                    magicPortals.push(p);
                    const el = document.getElementById(`box-${p}`);
                    if(el) el.classList.add('portal-tile');
                }
            }
        }

        function drawLaddersAndSnakes() {
            const svg = document.getElementById('game-svg');
            const defs = document.getElementById('snake-defs');
            const elements = svg.querySelectorAll('g:not(#snake-defs)');
            elements.forEach(el => el.remove());

            for(let s in ladders) drawRealisticLadder(svg, s, ladders[s]);
            
            const snakeColors = [
                {body: '#2e7d32', pattern: '#1b5e20'},
                {body: '#c62828', pattern: '#b71c1c'},
                {body: '#6a1b9a', pattern: '#4a148c'},
                {body: '#ef6c00', pattern: '#e65100'},
                {body: '#1565c0', pattern: '#0d47a1'}
            ];

            let colorIdx = 0;
            for(let s in snakes) {
                drawRealisticSnake(svg, defs, s, snakes[s], snakeColors[colorIdx % snakeColors.length]);
                colorIdx++;
            }
        }

        function drawRealisticLadder(svg, start, end) {
            const b1 = document.getElementById(`box-${start}`), b2 = document.getElementById(`box-${end}`);
            if(!b1 || !b2) return;
            const x1 = b1.offsetLeft + 32, y1 = b1.offsetTop + 32, x2 = b2.offsetLeft + 32, y2 = b2.offsetTop + 32;
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            const rail1 = createLine(x1-12, y1, x2-12, y2, "#5D4037", 6);
            const rail2 = createLine(x1+12, y1, x2+12, y2, "#5D4037", 6);
            g.appendChild(rail1); g.appendChild(rail2);
            let steps = 8;
            for(let i=1; i<steps; i++){
                let lx = x1 + (x2-x1)*(i/steps), ly = y1 + (y2-y1)*(i/steps);
                g.appendChild(createLine(lx-14, ly, lx+14, ly, "#8D6E63", 4));
            }
            svg.appendChild(g);
        }

        function drawRealisticSnake(svg, defs, start, end, colorSet) {
            const b1 = document.getElementById(`box-${start}`), b2 = document.getElementById(`box-${end}`);
            if(!b1 || !b2) return;
            const x1 = b1.offsetLeft + 32, y1 = b1.offsetTop + 32, x2 = b2.offsetLeft + 32, y2 = b2.offsetTop + 32;

            const gradId = `grad-${start}`;
            const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            grad.id = gradId; grad.setAttribute("x1", "0%"); grad.setAttribute("y1", "0%"); grad.setAttribute("x2", "100%"); grad.setAttribute("y2", "0%");
            grad.innerHTML = `<stop offset="0%" style="stop-color:${colorSet.body};stop-opacity:1" /><stop offset="50%" style="stop-color:${colorSet.pattern};stop-opacity:1" /><stop offset="100%" style="stop-color:${colorSet.body};stop-opacity:1" />`;
            defs.appendChild(grad);

            const snakeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            snakeGroup.classList.add('snake-path');

            const dx = x2 - x1, dy = y2 - y1;
            const midX1 = x1 + dx * 0.3 + (dx > 0 ? 50 : -50);
            const midY1 = y1 + dy * 0.3;
            const midX2 = x1 + dx * 0.7 - (dx > 0 ? 50 : -50);
            const midY2 = y1 + dy * 0.7;
            const d = `M ${x1} ${y1} C ${midX1} ${midY1}, ${midX2} ${midY2}, ${x2} ${y2}`;

            const shadow = document.createElementNS("http://www.w3.org/2000/svg", "path");
            shadow.setAttribute("d", d); shadow.setAttribute("stroke", "rgba(0,0,0,0.3)"); shadow.setAttribute("stroke-width", "16");
            shadow.setAttribute("fill", "none"); shadow.setAttribute("stroke-linecap", "round");
            shadow.style.transform = "translate(4px, 6px)";
            snakeGroup.appendChild(shadow);

            const body = document.createElementNS("http://www.w3.org/2000/svg", "path");
            body.setAttribute("d", d); body.setAttribute("stroke", `url(#${gradId})`); body.setAttribute("stroke-width", "14");
            body.setAttribute("fill", "none"); body.setAttribute("stroke-linecap", "round");
            snakeGroup.appendChild(body);

            const patternPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            patternPath.setAttribute("d", d); patternPath.setAttribute("stroke", "url(#pythonPatternBase)"); patternPath.setAttribute("stroke-width", "12");
            patternPath.setAttribute("fill", "none"); patternPath.setAttribute("stroke-linecap", "round");
            patternPath.style.opacity = "0.4";
            snakeGroup.appendChild(patternPath);

            const headG = document.createElementNS("http://www.w3.org/2000/svg", "g");
            const angle = Math.atan2(midY1 - y1, midX1 - x1) * 180 / Math.PI;
            
            const head = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
            head.setAttribute("cx", x1); head.setAttribute("cy", y1);
            head.setAttribute("rx", "12"); head.setAttribute("ry", "9");
            head.setAttribute("fill", colorSet.pattern);
            head.setAttribute("transform", `rotate(${angle}, ${x1}, ${y1})`);
            headG.appendChild(head);

            const eye1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            eye1.setAttribute("cx", x1 + 5); eye1.setAttribute("cy", y1 - 3); eye1.setAttribute("r", "2.5");
            eye1.setAttribute("fill", "white"); eye1.classList.add("snake-eye");
            eye1.setAttribute("transform", `rotate(${angle}, ${x1}, ${y1})`);

            const eye2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            eye2.setAttribute("cx", x1 + 5); eye2.setAttribute("cy", y1 + 3); eye2.setAttribute("r", "2.5");
            eye2.setAttribute("fill", "white"); eye2.classList.add("snake-eye");
            eye2.setAttribute("transform", `rotate(${angle}, ${x1}, ${y1})`);

            headG.appendChild(eye1);
            headG.appendChild(eye2);
            
            snakeGroup.appendChild(headG);
            svg.appendChild(snakeGroup);
        }

        function createLine(x1,y1,x2,y2,c,w){
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1",x1); l.setAttribute("y1",y1); l.setAttribute("x2",x2); l.setAttribute("y2",y2);
            l.setAttribute("stroke",c); l.setAttribute("stroke-width",w); l.setAttribute("stroke-linecap","round");
            return l;
        }

        function createTokens() {
            const layer = document.getElementById('tokens-layer');
            layer.innerHTML = "";
            players.forEach((p, i) => {
                const t = document.createElement('div');
                t.id = `token-${i}`; t.className = 'token';
                if(!p.active) t.style.display = 'none';
                let style = `background-color:${p.color};`;
                if(p.photo) style += `background-image:url(${p.photo});`;
                t.innerHTML = `<div class="horse"><div class="horse-body" style="${style}"></div><div class="horse-base"></div></div>`;
                layer.appendChild(t);
            });
        }

        async function handleRoll() {
            if (isMoving) return;
            const p = players[currentPlayerIndex];
            if(!p.active) return;
            
            const val = Math.floor(Math.random() * 10) + 1;
            await performRoll(val);
        }

        async function performRoll(val) {
            isMoving = true; playSound('roll');
            
            const dice = document.getElementById('dice');
            const depth = window.innerWidth < 600 ? 30 : 40;
            
            const rots = [
                {x: 0, y: 0},       // 1
                {x: 0, y: -90},     // 2
                {x: 0, y: -180},    // 3
                {x: 0, y: 90},      // 4
                {x: -90, y: 0},     // 5
                {x: 90, y: 0},      // 6
                {x: 45, y: 45},     // 7
                {x: -45, y: -45},   // 8
                {x: 180, y: 90},    // 9
                {x: 90, y: 180}     // 10
            ];
            
            totalDiceRotation += 1080; 
            const targetRot = rots[val-1];
            
            const faces = dice.querySelectorAll('.dice-face');
            faces.forEach(f => f.innerText = val);

            dice.style.transform = `rotateX(${targetRot.x + totalDiceRotation}deg) rotateY(${targetRot.y + totalDiceRotation}deg)`;
            
            await new Promise(r => setTimeout(r, 1500));
            await executeTurn(val);
        }

        async function executeTurn(val) {
            const p = players[currentPlayerIndex];
            const kill = await movePlayer(currentPlayerIndex, val);
            
            if (p.pos === 200) { 
                doWin(p.name, p.phone); 
                return; 
            }

            if (val === 10 || kill) {
                document.getElementById('status-msg').innerText = "BONUS TURN! üéØ";
                isMoving = false;
                if(p.isBot) setTimeout(() => performRoll(Math.floor(Math.random()*10)+1), 1000);
            } else {
                let nextTurn = (currentPlayerIndex + 1) % players.length;
                while(!players[nextTurn].active) {
                    nextTurn = (nextTurn + 1) % players.length;
                }
                currentPlayerIndex = nextTurn;
                updateTurnLabel();
                isMoving = false;
                if(players[currentPlayerIndex].isBot) setTimeout(() => performRoll(Math.floor(Math.random()*10)+1), 1000);
            }
        }

        async function movePlayer(idx, steps) {
            let p = players[idx];
            let target = p.pos + steps;
            if (target > 200) return false;

            for (let i = p.pos + 1; i <= target; i++) {
                p.pos = i; 
                playSound('move'); 
                updateTokensUI();
                await new Promise(r => setTimeout(r, 350));
            }

            let specialFound = true;
            while(specialFound) {
                specialFound = false;
                if (snakes[p.pos]) { 
                    playSound('snake'); 
                    p.pos = snakes[p.pos]; specialFound = true; 
                } else if (ladders[p.pos]) { 
                    playSound('ladder'); 
                    p.pos = ladders[p.pos]; specialFound = true; 
                } else if (magicPortals.includes(p.pos)) { 
                    p.pos = Math.floor(Math.random()*190)+5; specialFound = true; 
                }
                if(specialFound) { 
                    updateTokensUI(); 
                    await new Promise(r => setTimeout(r, 500)); 
                }
            }

            let kill = false;
            players.forEach((other, oi) => {
                if(oi !== idx && other.pos === p.pos && p.pos > 1 && other.active) { 
                    other.pos = 1; kill = true; 
                }
            });
            if(kill) updateTokensUI();
            return kill;
        }

        function updateTurnLabel() { 
            const p = players[currentPlayerIndex];
            if(!p) return;
            document.getElementById('turn-label').innerText = p.name;
            document.getElementById('turn-label').style.color = p.color;
            document.getElementById('status-msg').innerText = `It's YOUR turn!`; 
        }

        function updateTokensUI() {
            players.forEach((p, i) => {
                const t = document.getElementById(`token-${i}`);
                if(!t) return;
                if(!p.active) { t.style.display = 'none'; return; }
                const box = document.getElementById(`box-${p.pos}`);
                if (box) {
                    const off = (i % 5) * 4;
                    const vOff = Math.floor(i / 5) * 6;
                    t.style.left = (box.offsetLeft + 10 + off) + "px";
                    t.style.top = (box.offsetTop + 5 + vOff) + "px";
                    const horseBody = t.querySelector('.horse-body');
                    if(p.photo) horseBody.style.backgroundImage = `url(${p.photo})`;
                }
            });
        }

        function setupPanning() {
            const container = document.getElementById('game-container');
            const start = (e) => {
                if (e.target.closest('.ui-btn') || e.target.closest('.dice-area')) return;
                isDragging = true;
                const pt = e.touches ? e.touches[0] : e;
                startX = pt.clientX - translateX; startY = pt.clientY - translateY;
            };
            const move = (e) => {
                if (!isDragging) return;
                const pt = e.touches ? e.touches[0] : e;
                translateX = pt.clientX - startX; translateY = pt.clientY - startY;
                applyTransform();
            };
            container.addEventListener('mousedown', start);
            container.addEventListener('touchstart', start);
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move);
            window.addEventListener('mouseup', () => isDragging = false);
            window.addEventListener('touchend', () => isDragging = false);
        }

        function applyTransform() { 
            const board = document.getElementById('board-wrapper');
            if(board) board.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom}) rotateX(10deg)`; 
        }

        function adjustZoom(d) { zoom = Math.min(Math.max(0.3, zoom + d), 2); applyTransform(); }
        function playSound(n) { 
            if(!sfxOn) return;
            const s = soundEffects[n];
            if(s) { s.currentTime = 0; s.play().catch(()=>{}); }
        }

        function startWinCelebration() {
            const canvas = document.getElementById('fireworks-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const colors = ['#FF5252', '#FFD740', '#448AFF', '#4CAF50', '#E040FB', '#18FFFF', '#FF4081'];

            class Particle {
                constructor(x, y, color) {
                    this.x = x; this.y = y; this.color = color;
                    this.velocity = { x: (Math.random() - 0.5) * 12, y: (Math.random() - 0.5) * 12 };
                    this.alpha = 1; this.friction = 0.95; this.gravity = 0.2;
                }
                draw() {
                    ctx.globalAlpha = this.alpha;
                    ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                    ctx.fillStyle = this.color; ctx.fill();
                }
                update() {
                    this.velocity.x *= this.friction; this.velocity.y *= this.friction;
                    this.velocity.y += this.gravity;
                    this.x += this.velocity.x; this.y += this.velocity.y;
                    this.alpha -= 0.01;
                }
            }

            function spawnFirework() {
                const x = Math.random() * canvas.width;
                const y = Math.random() * (canvas.height * 0.5);
                const color = colors[Math.floor(Math.random() * colors.length)];
                for (let i = 0; i < 40; i++) particles.push(new Particle(x, y, color));
            }

            function animate() {
                if (document.getElementById('win-overlay').style.display !== 'flex') return;
                requestAnimationFrame(animate);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (Math.random() < 0.1) spawnFirework();
                particles.forEach((p, i) => {
                    if (p.alpha <= 0) particles.splice(i, 1);
                    else { p.update(); p.draw(); }
                });
            }
            animate();
        }

        function doWin(n, phone) { 
            playSound('win'); 
            document.getElementById('win-msg').innerText = n + " WON THE GAME!"; 
            document.getElementById('win-overlay').style.display = 'flex'; 
            startWinCelebration();
            
            if (phone) {
                let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
                let idx = users.findIndex(u => u.phone === phone);
                if (idx !== -1) {
                    users[idx].winCount = (users[idx].winCount || 0) + 1;
                    localStorage.setItem('magic200_users', JSON.stringify(users));
                    if (userProfileData.phone === phone) {
                        userProfileData.winCount = users[idx].winCount;
                        localStorage.setItem('magic200_profile', JSON.stringify(userProfileData));
                        // SYNC TO FIREBASE GLOBAL LEADERBOARD
                        db.ref('global_leader').set({ name: n, winCount: userProfileData.winCount });
                    }
                }
                
                let history = JSON.parse(localStorage.getItem('magic200_history') || "[]");
                history.unshift({ name: n, date: new Date().toLocaleString() });
                localStorage.setItem('magic200_history', JSON.stringify(history.slice(0, 20)));
            }
        }

        function updateHistoryUI() {
            const list = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('magic200_history') || "[]");
            list.innerHTML = history.length ? "" : "No wins yet.";
            history.forEach(h => {
                list.innerHTML += `<div class="history-item"><span>${h.name}</span><span>${h.date}</span></div>`;
            });
        }

        function updateLeaderTicker(snapshot) {
            let leader = null;
            if(snapshot && snapshot.val()) {
                leader = snapshot.val();
            } else {
                const users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
                if (!users.length) return;
                leader = users.reduce((prev, current) => ((prev.winCount || 0) > (current.winCount || 0)) ? prev : current);
            }
            
            const ticker = document.getElementById('ticker-content');
            if (leader && leader.winCount > 0) {
                ticker.innerText = `üî• CURRENT CHAMPION: ${leader.name} WITH ${leader.winCount} WINS! üî• PLAYER ${leader.name} IS DOMINATING THE BOARD! üî•`;
            } else {
                ticker.innerText = "Welcome to Magic 200 Pro! Start playing to become the first champion!";
            }
        }
    </script>
</body>
</html>
