<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic 200 Board Game 3D - Realistic Pro Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root {
            --red: #ff5252; --blue: #448aff; --green: #4caf50; --yellow: #ffd740;
            --orange: #ffab40; --pink: #ff4081; --purple: #e040fb; --cyan: #18ffff;
            --lgreen: #b2ff59; --skyblue: #40c4ff;
            --magic-glow: rgba(224, 64, 251, 0.6);
            --glass: rgba(255, 255, 255, 0.85);
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle, #455a64 0%, #263238 100%);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* --- MODERN HEADER --- */
        header {
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 3000;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        
        .menu-toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333;
            display: flex; align-items: center; justify-content: center;
        }

        .profile-btn {
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; background: rgba(0,0,0,0.05); padding: 6px 18px;
            border-radius: 50px; border: 1.5px solid #448aff;
            transition: 0.3s;
        }
        .profile-btn:hover { background: rgba(68, 138, 255, 0.1); }
        
        .avatar-circle {
            width: 35px; height: 35px; border-radius: 50%;
            object-fit: cover; border: 2px solid white; background: #eee;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        #user-name-disp { font-weight: 600; color: #333; }

        /* Wallet Styles */
        .wallet-display {
            background: #ffd740; color: #333; padding: 5px 15px; border-radius: 20px;
            font-weight: 800; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- SIDEBAR --- */
        #sidebar {
            position: fixed; left: calc(-1 * var(--sidebar-width)); top: 0;
            width: var(--sidebar-width); height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            z-index: 4000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; padding: 25px;
            color: #333;
        }
        #sidebar.active { left: 0; }
        .sidebar-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;
        }
        .sidebar-item {
            padding: 15px; margin: 5px 0; border-radius: 12px;
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .sidebar-item:hover { background: rgba(68, 138, 255, 0.1); color: var(--blue); }
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 3500; display: none; opacity: 0; transition: 0.3s;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- MENUS & OVERLAYS --- */
        #menu, .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; backdrop-filter: blur(8px);
        }
        .menu-title { 
            font-size: 3rem; color: white; margin-bottom: 2rem; 
            text-shadow: 0 0 20px var(--blue); font-weight: 900;
        }
        
        .menu-btn {
            padding: 16px 45px; margin: 12px; font-size: 1.2rem;
            border: none; border-radius: 15px; cursor: pointer;
            background: linear-gradient(135deg, var(--blue), var(--skyblue));
            color: white; transition: 0.4s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            width: 100%; max-width: 300px; font-weight: 600;
            position: relative;
        }
        .menu-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(68,138,255,0.5); }
        .menu-btn:disabled { background: #555 !important; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .online-tag {
            position: absolute; top: -10px; right: -10px;
            background: #4caf50; color: white; font-size: 0.7rem;
            padding: 2px 8px; border-radius: 10px; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .online-tag.offline { background: #e74c3c; }

        #offline-setup, #profile-modal, #global-setup, #signup-page, #login-page { display: none; z-index: 5000; }
        .setup-card { 
            background: white; padding: 30px; border-radius: 25px; 
            width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }
        .setup-card input[type="text"], .setup-card input[type="number"], .setup-card input[type="password"] { 
            width: 100%; padding: 12px; margin: 10px 0; 
            border: 2px solid #eee; border-radius: 12px; font-size: 1rem;
        }
        
        .pass-container { position: relative; }
        .toggle-pass { position: absolute; right: 15px; top: 22px; cursor: pointer; font-size: 1.2rem; }

        .image-upload-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px;
        }
        #profile-preview {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--blue);
        }
        .custom-file-upload {
            background: #eee; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
        }

        /* --- REALISTIC BOARD LAYOUT --- */
        #game-container {
            display: none;
            position: relative;
            width: 360px;
            height: 600px;
            margin: auto;
            overflow: auto;
            background: rgba(0,0,0,0.2);
            border: 5px solid #ecf0f1;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            perspective: 1500px;
        }
        #board-wrapper { 
            transform-style: preserve-3d; 
            position: absolute;
            top: 0; left: 0;
            transition: transform 0.3s ease;
            transform-origin: top left;
        }
        #board {
            display: grid; grid-template-columns: repeat(10, 65px); grid-template-rows: repeat(20, 65px);
            background: #2c3e50; border: 10px solid #ecf0f1; border-radius: 8px;
            position: relative; transform-style: preserve-3d;
        }

        .box {
            width: 65px; height: 65px; border: 0.5px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: #ffffff; 
            font-size: 1.1rem; position: relative;
            background-blend-mode: overlay;
            text-shadow: 1px 1px 2px #000;
            transform-style: preserve-3d;
            z-index: 60;
        }

        #game-svg {
            position: absolute; top: 0; left: 0;
            width: 650px; height: 1300px;
            pointer-events: none; z-index: 50;
        }

        .portal-tile { 
            background: var(--magic-glow) !important; 
            animation: portal-anim 3s infinite ease-in-out; 
        }
        @keyframes portal-anim {
            0%, 100% { box-shadow: inset 0 0 10px #fff; opacity: 0.8; }
            50% { box-shadow: inset 0 0 30px #fff; opacity: 1; }
        }

        .finish-box {
            background: linear-gradient(45deg, #ff5252, #448aff, #4caf50, #ffd740, #ffab40, #ff4081, #e040fb, #18ffff, #b2ff59, #40c4ff) !important;
            background-size: 400% 400% !important;
            animation: finish-glow 5s linear infinite;
            border: 4px solid gold !important;
            z-index: 70;
            color: white !important;
            font-size: 1.2rem !important;
            box-shadow: 0 0 25px gold;
        }
        @keyframes finish-glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .snake-path {
            animation: slither 3s infinite ease-in-out;
            transform-origin: center;
        }
        @keyframes slither {
            0%, 100% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.01) translate(2px, 2px); }
        }

        /* SNAKE EYE ANIMATION - REAL GLOW */
        .snake-eye {
            animation: snake-eye-glow 1.5s infinite alternate;
            filter: drop-shadow(0 0 5px #fff);
        }
        @keyframes snake-eye-glow {
            0% { fill: #fff; opacity: 1; r: 2.5; filter: drop-shadow(0 0 2px #fff); }
            100% { fill: #ffff00; opacity: 0.8; r: 3.5; filter: drop-shadow(0 0 10px #ffff00); }
        }

        .token {
            width: 35px; height: 35px; position: absolute; z-index: 100;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d; pointer-events: auto;
        }
        .horse { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; }
        .horse-body { 
            width: 20px; height: 35px; background: white; border-radius: 10px 10px 2px 2px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); border: 2px solid rgba(0,0,0,0.1);
            background-size: cover; background-position: center;
        }
        .horse-base { 
            width: 28px; height: 8px; background: rgba(0,0,0,0.5); 
            border-radius: 50%; position: absolute; bottom: -5px; filter: blur(2px);
        }

        /* --- ACTIVE TOKEN ANIMATION --- */
        .token-selectable {
            cursor: pointer;
            animation: token-jump 0.6s infinite alternate;
            z-index: 500;
        }
        @keyframes token-jump {
            from { transform: translateY(0); }
            to { transform: translateY(-15px); }
        }

        .ui-btn {
            width: 50px; height: 50px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
            background: #eee; color: #333; font-size: 1.4rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .ui-btn:active { transform: scale(0.9); }
        
        .volume-container {
            display: flex; align-items: center; gap: 8px;
        }
        #vol-slider {
            width: 80px; cursor: pointer;
        }

        #bottom-panel {
            height: 140px; background: var(--glass); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 20px; z-index: 1600;
        }

        .dice-area { width: 80px; height: 80px; perspective: 1000px; cursor: pointer; }
        .dice {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dice-face {
            position: absolute; width: 80px; height: 80px;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; font-weight: bold; color: white;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }
        .f1 { transform: rotateY(0deg) translateZ(40px); background: #e74c3c; }
        .f2 { transform: rotateY(90deg) translateZ(40px); background: #3498db; }
        .f3 { transform: rotateY(180deg) translateZ(40px); background: #2ecc71; }
        .f4 { transform: rotateY(-90deg) translateZ(40px); background: #f1c40f; color: #333; }
        .f5 { transform: rotateX(90deg) translateZ(40px); background: #e67e22; }
        .f6 { transform: rotateX(-90deg) translateZ(40px); background: #9b59b6; }

        #win-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            color: white; text-align: center;
        }
        .confetti { position: absolute; width: 10px; height: 10px; border-radius: 50%; animation: fall 3s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        /* WIN ANIMATIONS */
        .firework { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1s ease-out forwards; }
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(20); opacity: 0; }
        }
        .racket-anim { animation: racket-swing 0.5s infinite alternate; }
        @keyframes racket-swing {
            from { transform: rotate(-20deg); }
            to { transform: rotate(20deg); }
        }

        @media (max-width: 600px) {
            #game-container { width: 360px; height: 600px; }
            #board { grid-template-columns: repeat(10, 42px); grid-template-rows: repeat(20, 42px); }
            .box { width: 42px; height: 42px; font-size: 0.8rem; }
            #game-svg { width: 420px; height: 840px; }
            .dice-area { width: 60px; height: 60px; }
            .dice-face { width: 60px; height: 60px; font-size: 1.5rem; }
            .f1 { transform: rotateY(0deg) translateZ(30px); }
            .f2 { transform: rotateY(90deg) translateZ(30px); }
            .f3 { transform: rotateY(180deg) translateZ(30px); }
            .f4 { transform: rotateY(-90deg) translateZ(30px); }
            .f5 { transform: rotateX(90deg) translateZ(30px); }
            .f6 { transform: rotateX(-90deg) translateZ(30px); }
        }

        .coin-btn {
            background: #eee; border: 2px solid #ddd; padding: 10px; border-radius: 10px; 
            cursor: pointer; font-weight: bold; font-size: 1rem;
        }
        .coin-btn.selected { background: #ffd740; border-color: orange; }

        /* Multi-Goti Toggle Styling */
        .token-count-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .t-btn { padding: 8px 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .t-btn.selected { background: var(--blue); color: white; border-color: var(--blue); }

        /* NEW: Score Slider Style */
        #high-score-ticker {
            background: #333; color: #ffd740; overflow: hidden; white-space: nowrap;
            padding: 5px 0; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid #444;
        }
        .ticker-content { display: inline-block; animation: ticker 20s linear infinite; padding-left: 100%; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        .history-list { max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-top: 10px; text-align: left; font-size: 0.85rem; }
        .history-item { border-bottom: 1px solid #eee; padding: 5px 0; color: #555; display: flex; justify-content: space-between; }
    </style>
</head>
<body onload="initApp()">

    <div id="high-score-ticker" style="display:none;">
        <div class="ticker-content" id="ticker-text">üî• TOP PLAYER: Loading... üèÜ</div>
    </div>

    <div id="signup-page" class="modal-overlay" style="display: flex;">
        <div class="setup-card">
            <h2 style="color:#333">Create Account</h2>
            <input type="text" id="reg-name" placeholder="Full Name">
            <input type="number" id="reg-phone" placeholder="Phone Number">
            <div class="pass-container">
                <input type="password" id="reg-pass" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassVisibility('reg-pass')">üëÅÔ∏è</span>
            </div>
            <button class="menu-btn" onclick="handleSignup()">SUBMIT</button>
            <p style="color:#666; font-size: 0.9rem; margin-top: 15px;">
                Already registered? <span style="color:var(--blue); cursor:pointer; font-weight:bold;" onclick="switchAuth('login')">Login</span>
            </p>
        </div>
    </div>

    <div id="login-page" class="modal-overlay">
        <div class="setup-card">
            <h2 style="color:#333">Login</h2>
            <input type="number" id="log-phone" placeholder="Phone Number">
            <div class="pass-container">
                <input type="password" id="log-pass" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassVisibility('log-pass')">üëÅÔ∏è</span>
            </div>
            <button class="menu-btn" onclick="handleLogin()">LOGIN</button>
            <p style="color:#666; font-size: 0.9rem; margin-top: 15px;">
                New user? <span style="color:var(--blue); cursor:pointer; font-weight:bold;" onclick="switchAuth('signup')">Sign Up</span>
            </p>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; color:var(--blue);">Game Menu</h2>
            <button class="menu-toggle-btn" onclick="toggleSidebar()">‚úï</button>
        </div>
        
        <div class="sidebar-item" onclick="forceQuit()">
            <span>üè†</span> Home
        </div>
        <div class="sidebar-item" onclick="openProfile()">
            <span>üë§</span> Change Photo / Profile
        </div>
        <div class="sidebar-item" onclick="referGame()">
            <span>üéÅ</span> Refer
        </div>
        <div class="sidebar-item" onclick="shareGame()">
            <span>üì§</span> Share
        </div>
        <div class="sidebar-item" onclick="alert('Magic 200 Rules:\n1. Roll dice to move.\n2. Ladders take you UP.\n3. Snakes take you DOWN.\n4. Magic Portals teleport you randomly!\n5. Landing on opponent sends them to 1!\n6. Bonus turn on 10, killing someone, or reaching 200.')">
            <span>üìú</span> Game Rules
        </div>
        <div class="sidebar-item" onclick="contactSupport()">
            <span>üéß</span> Help and Support
        </div>
        
        <div class="sidebar-item" onclick="alert('Version 3.0.1 Pro Edition\nCreated for ultimate fun!')">
            <span>‚Ñπ</span> About Game
        </div>

        <div class="sidebar-item" onclick="logoutUser()" style="color: #e74c3c; font-weight: bold;">
            <span>üö™</span> Logout
        </div>
        
        <div class="sidebar-item" onclick="location.reload()" style="margin-top: auto; border-top: 1px solid #eee;">
            <span>üîÑ</span> Restart
        </div>
    </aside>

    <header id="main-header" style="display: none;">
        <div class="header-left">
            <button class="menu-toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div class="logo" style="font-weight: 900; color: var(--blue); font-size: 1.4rem; letter-spacing: 1px;">MAGIC 200 PRO</div>
        </div>
        
        <div class="wallet-display">
            ü™ô <span id="user-coins">1000</span>
        </div>

        <div class="profile-btn" onclick="openProfile()">
            <img id="user-avatar-disp" class="avatar-circle" src="" alt="üë§" onerror="this.style.display='none'">
            <span id="user-name-disp">Guest Player</span>
        </div>
    </header>

    <div id="menu" style="display: none;">
        <h1 class="menu-title">Magic 200</h1>
        <button class="menu-btn" id="global-match-btn" onclick="showGlobalSetup()">
            üåê GLOBAL MATCH (MULTI)
            <span class="online-tag" id="online-count">Checking...</span>
        </button>
        <button class="menu-btn" onclick="startMode('vs')">ü§ñ VS COMPUTER</button>
        <button class="menu-btn" onclick="showOfflineSetup()">üë• LOCAL MULTIPLAYER</button>
    </div>

    <div id="global-setup" class="modal-overlay">
        <div class="setup-card">
            <div id="coin-step">
                <h2 style="color:#333">Select Bet Coins</h2>
                <div id="coin-selection" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div class="coin-btn" onclick="selectCoin(10, this)">10</div>
                    <div class="coin-btn" onclick="selectCoin(50, this)">50</div>
                    <div class="coin-btn selected" onclick="selectCoin(100, this)">100</div>
                    <div class="coin-btn" onclick="selectCoin(200, this)">200</div>
                    <div class="coin-btn" onclick="selectCoin(500, this)">500</div>
                    <div class="coin-btn" onclick="selectCoin(1000, this)">1000</div>
                </div>
                <button class="menu-btn" onclick="startGlobalMatchNow()">START GLOBAL MATCH</button>
                <button class="menu-btn" style="background:#ccc; color:#333; margin-top:20px;" onclick="hideGlobalSetup()">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="setup-card">
            <h2 style="color:#333">Edit Profile</h2>
            
            <div class="image-upload-wrapper">
                <img id="profile-preview" src="https://via.placeholder.com/80" alt="Preview">
                <label class="custom-file-upload">
                    <input type="file" id="profile-image-input" accept="image/*" style="display:none;" onchange="previewImage(this)">
                    Choose Photo
                </label>
            </div>

            <input type="text" id="profile-name" placeholder="Your Name">

            <h3 style="margin: 15px 0 5px; font-size: 1rem;">Win History</h3>
            <div class="history-list" id="win-history-list">
                <div style="text-align:center; color:#999;">No wins yet!</div>
            </div>
            
            <button class="menu-btn" onclick="saveProfile()" style="margin-top:15px;">SAVE CHANGES</button>
            <button class="menu-btn" style="background:#ccc; color:#333" onclick="document.getElementById('profile-modal').style.display='none'">CANCEL</button>
        </div>
    </div>

    <div id="offline-setup" class="modal-overlay">
        <div class="setup-card" id="step-1">
            <h2 style="color:#333">Game Settings</h2>
            <p style="margin: 0; color: #555;">How many players?</p>
            <input type="number" id="player-count" min="2" max="6" value="2">
            
            <p style="margin: 10px 0 0; color: #555;">How many tokens (Goti)?</p>
            <div class="token-count-container">
                <button class="t-btn selected" onclick="selectTokens(1, this)">Single</button>
                <button class="t-btn" onclick="selectTokens(2, this)">Two</button>
                <button class="t-btn" onclick="selectTokens(4, this)">Four</button>
            </div>

            <h3 style="color:#333; margin-top: 20px;">Player Names</h3>
            <div id="name-inputs-list" style="max-height: 180px; overflow-y: auto; margin-bottom: 10px;"></div>

            <button class="menu-btn" onclick="startOfflineGame()">START ADVENTURE</button>
            <button class="menu-btn" style="background: #ccc; color: #333;" onclick="hideOfflineSetup()">BACK</button>
        </div>
    </div>

    <div id="game-container">
        <div id="board-wrapper">
            <div id="board"></div>
            <svg id="game-svg">
                <defs id="snake-defs">
                    <pattern id="pythonPatternBase" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
                        <circle cx="5" cy="5" r="3" fill="rgba(0,0,0,0.4)" />
                        <circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)" />
                    </pattern>
                </defs>
            </svg>
            <div id="tokens-layer"></div>
        </div>
    </div>

    <div id="bottom-panel" style="display:none">
        <div style="text-align:left; min-width: 120px;">
            <div id="room-id-label" style="font-size: 0.7rem; color: #777; font-weight: bold;"></div>
            <div id="turn-label" style="font-weight:800; color:var(--blue); font-size:1.1rem;">Player 1</div>
            <div id="status-msg" style="font-size:0.85rem; color:#555; font-weight: 500;">Ready to roll?</div>
            <div class="volume-container" style="margin-top: 5px;">
                <button class="ui-btn" id="sfx-toggle" style="width:35px; height:35px; font-size:1rem;">üîä</button>
                <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.2">
                <button class="ui-btn" onclick="quitToMenu()" style="width:35px; height:35px; font-size:1rem; color: #e74c3c;">üè†</button>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 5px;">
            <button class="ui-btn" onclick="changeZoom(0.1)" style="width:35px; height:35px; font-weight:bold;">+</button>
            <button class="ui-btn" onclick="changeZoom(-0.1)" style="width:35px; height:35px; font-weight:bold;">-</button>
        </div>
        
        <div class="dice-area" id="dice-trigger">
            <div class="dice" id="dice">
                <div class="dice-face f1" id="df-1">1</div>
                <div class="dice-face f2" id="df-2">2</div>
                <div class="dice-face f3" id="df-3">3</div>
                <div class="dice-face f4" id="df-4">4</div>
                <div class="dice-face f5" id="df-5">5</div>
                <div class="dice-face f6" id="df-6">6</div>
            </div>
        </div>

        <button id="host-restart-btn" class="ui-btn" onclick="handleHostRestart()" style="font-size: 1.2rem; display:none;">üîÑ</button>
    </div>

    <div id="win-overlay">
        <div id="confetti-container"></div>
        <div id="fireworks-container" style="position:absolute; inset:0; pointer-events:none;"></div>
        <div id="racket-icon" style="font-size:5rem; position:absolute; top:10%; display:none;">üè∏</div>
        <h1 id="win-msg" style="font-size: 4rem; text-shadow: 0 0 25px gold; margin:0;">VICTORY!</h1>
        <p id="win-sub" style="font-size: 1.5rem; color: gold; font-weight: bold;"></p>
        <button class="menu-btn" onclick="forceQuit()" style="margin-top:60px; padding: 10px 30px; font-size: 1rem; width: auto; max-width: 200px;">QUIT TO HOME</button>
    </div>

    <audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>

    <script>
        // --- CONFIG & GLOBAL STATE ---
        const CONFIG = {
            apiKey: "AIzaSyAAqOJp30w7TEMXG8oHUmMTDpOy8BjboDY",
            colors: ['#ff5252', '#448aff', '#4caf50', '#ffd740', '#ffab40', '#e040fb', '#ff4081', '#18ffff', '#b2ff59', '#40c4ff'],
            maxPlayersPerRoom: 10
        };

        let currentPlayerIndex = 0;
        let players = []; 
        let isMoving = false;
        let zoom = 1;
        let sfxOn = true;
        let magicPortals = [], snakes = {}, ladders = {};
        let totalDiceRotation = 0;
        let userProfileData = { name: "Guest Player", photo: "", coins: 1000, phone: "", password: "", totalWins: 0, winHistory: [] };
        let activeMovementTimeout = null;
        let isGlobalMatch = false;
        let isHost = false;
        let isWaitingForRestart = false;
        let selectedBet = 100;
        let currentRoomId = null;
        let roomPlayersList = [];
        let tokensPerPlayer = 1;
        let currentRollValue = 0;

        const soundEffects = {
            roll: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            move: new Audio('https://assets.mixkit.co/active_storage/sfx/1113/1113-preview.mp3'),
            win: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            snake: new Audio('https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3'),
            ladder: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            firework: new Audio('https://assets.mixkit.co/active_storage/sfx/588/588-preview.mp3')
        };

        function initApp() {
            const loggedIn = localStorage.getItem('magic200_logged_in');
            if (loggedIn === 'true') {
                showGameMenu();
                loadSavedProfile();
                updateHighScoreTicker();
            } else {
                switchAuth('signup');
            }
            updateOnlineStatus();
            setInterval(updateOnlineStatus, 5000);
            document.getElementById('player-count').addEventListener('input', updateNameInputs);
        }

        function switchAuth(type) {
            document.getElementById('signup-page').style.display = (type === 'signup') ? 'flex' : 'none';
            document.getElementById('login-page').style.display = (type === 'login') ? 'flex' : 'none';
        }

        function togglePassVisibility(id) {
            const input = document.getElementById(id);
            input.type = (input.type === 'password') ? 'text' : 'password';
        }

        function handleSignup() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            if (!name || !phone || !pass) { alert("Please fill all fields"); return; }
            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            if (users.find(u => u.phone === phone)) { alert("Already Registered this number!"); return; }
            const newUser = { name, phone, password: pass, coins: 1000, photo: "", totalWins: 0, winHistory: [] };
            users.push(newUser);
            localStorage.setItem('magic200_users', JSON.stringify(users));
            alert("Signup successful! Please Login.");
            switchAuth('login');
        }

        function handleLogin() {
            const phone = document.getElementById('log-phone').value.trim();
            const pass = document.getElementById('log-pass').value.trim();
            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            const user = users.find(u => u.phone === phone && u.password === pass);
            if (user) {
                userProfileData = user;
                if(!userProfileData.winHistory) userProfileData.winHistory = [];
                if(!userProfileData.totalWins) userProfileData.totalWins = 0;
                localStorage.setItem('magic200_profile', JSON.stringify(user));
                localStorage.setItem('magic200_logged_in', 'true');
                showGameMenu();
                loadSavedProfile();
                updateHighScoreTicker();
            } else { alert("Invalid number or password!"); }
        }

        function showGameMenu() {
            document.getElementById('signup-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('high-score-ticker').style.display = 'block';
        }

        function logoutUser() {
            if(confirm("Are you sure you want to logout?")) {
                localStorage.setItem('magic200_logged_in', 'false');
                location.reload();
            }
        }

        function updateOnlineStatus() {
            const el = document.getElementById('online-count');
            const btn = document.getElementById('global-match-btn');
            if (navigator.onLine) {
                const count = Math.floor(800 + Math.random() * 200);
                el.innerText = count.toLocaleString() + " Online";
                el.classList.remove('offline');
                btn.disabled = false;
                btn.style.opacity = "1";
            } else {
                el.innerText = "OFFLINE";
                el.classList.add('offline');
                btn.disabled = true;
                btn.style.opacity = "0.6";
            }
        }

        function showGlobalSetup() { document.getElementById('global-setup').style.display = 'flex'; }
        function hideGlobalSetup() { document.getElementById('global-setup').style.display = 'none'; }
        function selectCoin(val, el) {
            selectedBet = val;
            document.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function startGlobalMatchNow() {
            if(userProfileData.coins < selectedBet) { alert("Not enough coins!"); return; }
            userProfileData.coins -= selectedBet;
            saveProfile();
            isGlobalMatch = true;
            isHost = false;
            isWaitingForRestart = false;
            players = [
                { name: userProfileData.name, positions: [1], color: CONFIG.colors[0], isBot: false, photo: userProfileData.photo, tokenCount: 1 },
                { name: "Online Opponent", positions: [1], color: CONFIG.colors[1], isBot: true, photo: "", tokenCount: 1 }
            ];
            initGame();
            document.getElementById('room-id-label').innerText = "GLOBAL MATCH";
        }

        function loadSavedProfile() {
            const saved = localStorage.getItem('magic200_profile');
            if(saved) {
                userProfileData = JSON.parse(saved);
                document.getElementById('user-name-disp').innerText = userProfileData.name;
                document.getElementById('profile-name').value = userProfileData.name;
                document.getElementById('user-coins').innerText = userProfileData.coins || 1000;
                if(userProfileData.photo) {
                    const avatar = document.getElementById('user-avatar-disp');
                    avatar.src = userProfileData.photo;
                    avatar.style.display = 'block';
                    document.getElementById('profile-preview').src = userProfileData.photo;
                }
                updateWinHistoryUI();
            }
        }

        function updateWinHistoryUI() {
            const list = document.getElementById('win-history-list');
            if(!userProfileData.winHistory || userProfileData.winHistory.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999;">No wins yet!</div>';
            } else {
                list.innerHTML = userProfileData.winHistory.map(h => `
                    <div class="history-item">
                        <span>üèÜ Win vs ${h.opponent}</span>
                        <span>${h.date}</span>
                    </div>
                `).join('');
            }
        }

        function updateHighScoreTicker() {
            const users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            if(users.length > 0) {
                const topPlayer = users.sort((a, b) => (b.totalWins || 0) - (a.totalWins || 0))[0];
                if(topPlayer) {
                    document.getElementById('ticker-text').innerText = `üî• TOP PLAYER: ${topPlayer.name} with ${topPlayer.totalWins || 0} Wins! üèÜ Join and beat the score! üéØ`;
                }
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-preview').src = e.target.result;
                    userProfileData.photo = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const nameInput = document.getElementById('profile-name').value.trim();
            if(nameInput) userProfileData.name = nameInput;
            localStorage.setItem('magic200_profile', JSON.stringify(userProfileData));
            let users = JSON.parse(localStorage.getItem('magic200_users') || "[]");
            let index = users.findIndex(u => u.phone === userProfileData.phone);
            if (index !== -1) { users[index] = userProfileData; localStorage.setItem('magic200_users', JSON.stringify(users)); }
            document.getElementById('user-name-disp').innerText = userProfileData.name;
            document.getElementById('user-coins').innerText = userProfileData.coins;
            const avatar = document.getElementById('user-avatar-disp');
            if(userProfileData.photo) { avatar.src = userProfileData.photo; avatar.style.display = 'block'; }
            document.getElementById('profile-modal').style.display = 'none';
            updateHighScoreTicker();
        }

        document.getElementById('dice-trigger').addEventListener('click', handleRoll);
        const volSlider = document.getElementById('vol-slider');
        const bgMusic = document.getElementById('bg-music');
        volSlider.addEventListener('input', (e) => {
            bgMusic.volume = e.target.value;
            if (bgMusic.paused && e.target.value > 0) bgMusic.play().catch(()=>{});
        });

        const sfxBtn = document.getElementById('sfx-toggle');
        sfxBtn.addEventListener('click', () => {
            sfxOn = !sfxOn;
            sfxBtn.innerText = sfxOn ? "üîä" : "üîá";
            sfxBtn.style.opacity = sfxOn ? "1" : "0.5";
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function openProfile() { 
            document.getElementById('profile-modal').style.display = 'flex'; 
            document.getElementById('profile-name').value = userProfileData.name;
            if(userProfileData.photo) document.getElementById('profile-preview').src = userProfileData.photo;
            updateWinHistoryUI();
            if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        }

        function referGame() {
            const code = "MAGIC" + Math.floor(1000 + Math.random() * 9000);
            alert("Your Referral Code: " + code + "\nShare this with friends to earn magic coins!");
        }

        function shareGame() {
            const shareUrl = "https://imran13144.github.io/Tic-Tac-Toe-Dawnload/";
            const shareTitle = "Magic 200 Pro - Ultimate 3D Board Game";
            if (navigator.share) {
                navigator.share({ title: shareTitle, text: "Play Magic 200 Pro!", url: shareUrl }).catch(() => {});
            } else { alert("Game Link Copied to Clipboard!\n" + shareUrl); }
        }

        function contactSupport() { alert("Help & Support:\nEmail: support@magic200pro.com"); }

        function startMode(mode) {
            isGlobalMatch = false; isHost = false; isWaitingForRestart = false; tokensPerPlayer = 1;
            if(mode === 'vs') {
                players = [
                    { name: userProfileData.name, positions: [1], color: CONFIG.colors[0], isBot: false, photo: userProfileData.photo, tokenCount: 1 },
                    { name: "CPU AI", positions: [1], color: CONFIG.colors[1], isBot: true, photo: "", tokenCount: 1 }
                ];
            }
            initGame();
        }

        function showOfflineSetup() { document.getElementById('offline-setup').style.display = 'flex'; updateNameInputs(); }
        function hideOfflineSetup() { document.getElementById('offline-setup').style.display = 'none'; }
        function selectTokens(num, el) {
            tokensPerPlayer = num;
            document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function updateNameInputs() {
            const count = Math.min(Math.max(parseInt(document.getElementById('player-count').value), 2), 6);
            const list = document.getElementById('name-inputs-list');
            list.innerHTML = "";
            for(let i=1; i<=count; i++) {
                let defaultVal = (i===1) ? userProfileData.name : `Player ${i}`;
                list.innerHTML += `<input type="text" id="pname-${i}" value="${defaultVal}">`;
            }
        }

        function startOfflineGame() {
            const count = parseInt(document.getElementById('player-count').value);
            players = []; isGlobalMatch = false; isHost = false;
            for(let i=1; i<=count; i++) {
                let n = document.getElementById(`pname-${i}`).value.trim() || `Player ${i}`;
                let posArray = [];
                for(let t=0; t<tokensPerPlayer; t++) posArray.push(1);
                players.push({ 
                    name: n, positions: posArray, color: CONFIG.colors[(i-1)%CONFIG.colors.length], 
                    isBot: false, photo: (i === 1) ? userProfileData.photo : "", tokenCount: tokensPerPlayer 
                });
            }
            initGame();
        }

        function initGame() {
            document.getElementById('main-header').style.display = 'none'; 
            document.getElementById('menu').style.display = 'none';
            document.getElementById('offline-setup').style.display = 'none';
            document.getElementById('global-setup').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('bottom-panel').style.display = 'flex';
            document.getElementById('high-score-ticker').style.display = 'none';
            generateBoard();
            generateSpecialTiles();
            createTokens();
            updateTurnLabel();
            updateTokensUI();
            bgMusic.volume = volSlider.value;
            bgMusic.play().catch(()=>{});
            setTimeout(drawLaddersAndSnakes, 600);
        }

        function forceQuit() {
            isMoving = false; isGlobalMatch = false;
            if(activeMovementTimeout) clearTimeout(activeMovementTimeout);
            bgMusic.pause();
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('bottom-panel').style.display = 'none';
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('win-overlay').style.display = 'none';
            document.getElementById('high-score-ticker').style.display = 'block';
            if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        }

        function quitToMenu() { if(confirm("Are you sure you want to quit?")) forceQuit(); }

        function changeZoom(val) {
            zoom = Math.max(0.5, Math.min(2, zoom + val));
            document.getElementById('board-wrapper').style.transform = `scale(${zoom})`;
        }

        function generateBoard() {
            const board = document.getElementById('board');
            board.innerHTML = "";
            for (let row = 19; row >= 0; row--) {
                for (let col = 0; col < 10; col++) {
                    let num = (row % 2 === 0) ? (row * 10) + (10 - col) : (row * 10) + (col + 1);
                    const box = document.createElement('div');
                    box.id = `box-${num}`; box.className = 'box';
                    box.style.background = CONFIG.colors[(num - 1) % 10];
                    box.innerText = num;
                    box.style.order = (19 - row) * 10 + col;
                    if(num === 200) { box.classList.add('finish-box'); box.innerText = "üèÜ 200"; }
                    board.appendChild(box);
                }
            }
        }

        function generateSpecialTiles() {
            ladders = { 3: 22, 15: 44, 28: 84, 50: 91, 78: 122, 105: 146, 120: 180, 150: 192 };
            snakes = { 25: 5, 48: 12, 62: 18, 98: 70, 130: 101, 160: 140, 188: 152, 197: 165 };
            magicPortals = [];
            while(magicPortals.length < 10) {
                let p = Math.floor(Math.random()*185)+10;
                if(!ladders[p] && !snakes[p] && !magicPortals.includes(p) && p !== 200) {
                    magicPortals.push(p);
                    const el = document.getElementById(`box-${p}`);
                    if(el) el.classList.add('portal-tile');
                }
            }
        }

        function drawLaddersAndSnakes() {
            const svg = document.getElementById('game-svg');
            const defs = document.getElementById('snake-defs');
            svg.querySelectorAll('g:not(#snake-defs)').forEach(el => el.remove());
            for(let s in ladders) drawRealisticLadder(svg, s, ladders[s]);
            const snakeColors = [{body: '#2e7d32', pattern: '#1b5e20'},{body: '#c62828', pattern: '#b71c1c'},{body: '#6a1b9a', pattern: '#4a148c'}];
            let colorIdx = 0;
            for(let s in snakes) { drawRealisticSnake(svg, defs, s, snakes[s], snakeColors[colorIdx % snakeColors.length]); colorIdx++; }
        }

        function drawRealisticLadder(svg, start, end) {
            const b1 = document.getElementById(`box-${start}`), b2 = document.getElementById(`box-${end}`);
            if(!b1 || !b2) return;
            const x1 = b1.offsetLeft + 32, y1 = b1.offsetTop + 32, x2 = b2.offsetLeft + 32, y2 = b2.offsetTop + 32;
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.appendChild(createLine(x1-12, y1, x2-12, y2, "#5D4037", 6));
            g.appendChild(createLine(x1+12, y1, x2+12, y2, "#5D4037", 6));
            for(let i=1; i<8; i++){
                let lx = x1 + (x2-x1)*(i/8), ly = y1 + (y2-y1)*(i/8);
                g.appendChild(createLine(lx-14, ly, lx+14, ly, "#8D6E63", 4));
            }
            svg.appendChild(g);
        }

        function drawRealisticSnake(svg, defs, start, end, colorSet) {
            const b1 = document.getElementById(`box-${start}`), b2 = document.getElementById(`box-${end}`);
            if(!b1 || !b2) return;
            const x1 = b1.offsetLeft + 32, y1 = b1.offsetTop + 32, x2 = b2.offsetLeft + 32, y2 = b2.offsetTop + 32;
            
            const gradId = `grad-${start}`;
            const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            grad.id = gradId; grad.setAttribute("x1", "0%"); grad.setAttribute("y1", "0%"); grad.setAttribute("x2", "100%"); grad.setAttribute("y2", "0%");
            grad.innerHTML = `<stop offset="0%" style="stop-color:${colorSet.body}" /><stop offset="50%" style="stop-color:${colorSet.pattern}" /><stop offset="100%" style="stop-color:${colorSet.body}" />`;
            defs.appendChild(grad);

            const snakeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            snakeGroup.classList.add('snake-path');
            
            const dx = x2 - x1, dy = y2 - y1;
            const midX1 = x1 + dx * 0.3 + 40, midY1 = y1 + dy * 0.3;
            const midX2 = x1 + dx * 0.7 - 40, midY2 = y1 + dy * 0.7;
            const dPath = `M ${x1} ${y1} C ${midX1} ${midY1}, ${midX2} ${midY2}, ${x2} ${y2}`;

            const body = document.createElementNS("http://www.w3.org/2000/svg", "path");
            body.setAttribute("d", dPath); body.setAttribute("stroke", `url(#${gradId})`); 
            body.setAttribute("stroke-width", "18"); body.setAttribute("fill", "none"); 
            body.setAttribute("stroke-linecap", "round");
            body.setAttribute("filter", "drop-shadow(2px 4px 6px rgba(0,0,0,0.5))");
            // Realistic Skin Pattern
            const pattern = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pattern.setAttribute("d", dPath); pattern.setAttribute("stroke", "url(#pythonPatternBase)");
            pattern.setAttribute("stroke-width", "18"); pattern.setAttribute("fill", "none"); pattern.setAttribute("stroke-linecap", "round");
            
            snakeGroup.appendChild(body);
            snakeGroup.appendChild(pattern);

            // Realistic Head (Diamond Shape)
            const head = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const headD = `M ${x1-14} ${y1} Q ${x1} ${y1-22} ${x1+14} ${y1} Q ${x1} ${y1+10} ${x1-14} ${y1}`;
            head.setAttribute("d", headD); head.setAttribute("fill", colorSet.body);
            const angle = Math.atan2(midY1 - y1, midX1 - x1) * 180 / Math.PI;
            head.setAttribute("transform", `rotate(${angle + 90}, ${x1}, ${y1})`);
            snakeGroup.appendChild(head);

            // Tongue
            const tongue = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tongue.setAttribute("d", `M ${x1} ${y1-12} L ${x1-4} ${y1-22} M ${x1} ${y1-12} L ${x1+4} ${y1-22}`); 
            tongue.setAttribute("stroke", "#ff1744"); tongue.setAttribute("stroke-width", "2");
            tongue.setAttribute("transform", `rotate(${angle + 90}, ${x1}, ${y1})`);
            snakeGroup.appendChild(tongue);

            // Glowing Snake Eyes
            const eye1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            eye1.setAttribute("cx", x1-6); eye1.setAttribute("cy", y1-8); eye1.setAttribute("r", "3");
            eye1.classList.add('snake-eye');
            eye1.setAttribute("transform", `rotate(${angle + 90}, ${x1}, ${y1})`);
            
            const eye2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            eye2.setAttribute("cx", x1+6); eye2.setAttribute("cy", y1-8); eye2.setAttribute("r", "3");
            eye2.classList.add('snake-eye');
            eye2.setAttribute("transform", `rotate(${angle + 90}, ${x1}, ${y1})`);

            snakeGroup.appendChild(eye1);
            snakeGroup.appendChild(eye2);

            svg.appendChild(snakeGroup);
        }

        function createLine(x1,y1,x2,y2,c,w){
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1",x1); l.setAttribute("y1",y1); l.setAttribute("x2",x2); l.setAttribute("y2",y2);
            l.setAttribute("stroke",c); l.setAttribute("stroke-width",w); l.setAttribute("stroke-linecap","round");
            return l;
        }

        function createTokens() {
            const layer = document.getElementById('tokens-layer'); layer.innerHTML = "";
            players.forEach((p, i) => {
                for(let tNum = 0; tNum < (p.tokenCount||1); tNum++) {
                    const t = document.createElement('div');
                    t.id = `token-${i}-${tNum}`; t.className = 'token';
                    let style = `background-color:${p.color};`;
                    if(p.photo) style += `background-image:url(${p.photo});`;
                    t.innerHTML = `<div class="horse"><div class="horse-body" style="${style}"></div><div class="horse-base"></div></div>`;
                    t.onclick = () => handleTokenClick(i, tNum);
                    layer.appendChild(t);
                }
            });
        }

        async function handleRoll() {
            if (isMoving || isWaitingForRestart) return;
            isMoving = true; playSound('roll');
            const val = Math.floor(Math.random() * 10) + 1;
            currentRollValue = val;
            
            for(let i=1; i<=6; i++) {
                const face = document.getElementById(`df-${i}`);
                if(i === 1) face.innerText = val;
                else face.innerText = Math.floor(Math.random() * 10) + 1;
            }

            const dice = document.getElementById('dice');
            totalDiceRotation += 720;
            dice.style.transform = `rotateX(${totalDiceRotation}deg) rotateY(${totalDiceRotation}deg)`;
            await new Promise(r => setTimeout(r, 1500));
            
            prepareTokenSelection();
        }

        function prepareTokenSelection() {
            const p = players[currentPlayerIndex];
            let canMoveAtLeastOne = false;
            
            for(let tNum = 0; tNum < (p.tokenCount||1); tNum++) {
                if(p.positions[tNum] + currentRollValue <= 200 && p.positions[tNum] < 200) {
                    const tEl = document.getElementById(`token-${currentPlayerIndex}-${tNum}`);
                    if(tEl) tEl.classList.add('token-selectable');
                    canMoveAtLeastOne = true;
                }
            }

            if(!canMoveAtLeastOne) {
                document.getElementById('status-msg').innerText = "No moves possible!";
                setTimeout(nextTurn, 1000);
            } else {
                document.getElementById('status-msg').innerText = "Select a token to move!";
                if(p.isBot) {
                    setTimeout(() => {
                        for(let t=0; t<p.tokenCount; t++) {
                            if(p.positions[t] + currentRollValue <= 200 && p.positions[t] < 200) {
                                handleTokenClick(currentPlayerIndex, t);
                                break;
                            }
                        }
                    }, 800);
                }
            }
        }

        async function handleTokenClick(pIdx, tIdx) {
            if(pIdx !== currentPlayerIndex) return;
            const tEl = document.getElementById(`token-${pIdx}-${tIdx}`);
            if(!tEl || !tEl.classList.contains('token-selectable')) return;

            document.querySelectorAll('.token').forEach(t => t.classList.remove('token-selectable'));
            
            const startPos = players[pIdx].positions[tIdx];
            const kill = await movePlayerToken(pIdx, tIdx, currentRollValue);
            const endPos = players[pIdx].positions[tIdx];

            let reachedFinishInThisTurn = (startPos < 200 && endPos === 200);

            if (players[pIdx].positions.every(pos => pos === 200)) { 
                doWin(players[pIdx].name); 
                return; 
            }

            // Bonus logic: 10 roll, killing someone, or reaching 200
            if (currentRollValue === 10 || kill || reachedFinishInThisTurn) {
                document.getElementById('status-msg').innerText = "BONUS TURN! üéØ";
                isMoving = false;
                if(players[currentPlayerIndex].isBot) setTimeout(handleRoll, 1000);
            } else {
                nextTurn();
            }
        }

        function nextTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateTurnLabel();
            isMoving = false;
            if(players[currentPlayerIndex].isBot) setTimeout(handleRoll, 1000);
        }

        async function movePlayerToken(pIdx, tIdx, steps) {
            let p = players[pIdx];
            let target = p.positions[tIdx] + steps;
            if (target > 200) return false;

            for (let i = p.positions[tIdx] + 1; i <= target; i++) {
                p.positions[tIdx] = i; playSound('move'); updateTokensUI();
                await new Promise(r => setTimeout(r, 350));
            }
            
            if (snakes[p.positions[tIdx]]) { p.positions[tIdx] = snakes[p.positions[tIdx]]; playSound('snake'); }
            else if (ladders[p.positions[tIdx]]) { p.positions[tIdx] = ladders[p.positions[tIdx]]; playSound('ladder'); }
            else if (magicPortals.includes(p.positions[tIdx])) {
                let randTarget = Math.floor(Math.random() * 198) + 2;
                p.positions[tIdx] = randTarget;
                playSound('ladder'); 
            }
            updateTokensUI();

            let kill = false;
            players.forEach((other, oi) => {
                if(oi !== pIdx) {
                    other.positions.forEach((oPos, otIdx) => {
                        if(oPos === p.positions[tIdx] && oPos > 1 && oPos < 200) {
                            other.positions[otIdx] = 1; kill = true;
                        }
                    });
                }
            });
            if(kill) updateTokensUI();
            return kill;
        }

        function updateTurnLabel() { 
            const p = players[currentPlayerIndex];
            document.getElementById('turn-label').innerText = p.name;
            document.getElementById('turn-label').style.color = p.color;
            document.getElementById('status-msg').innerText = p.name === userProfileData.name ? "YOUR Turn!" : "Waiting...";
        }

        function updateTokensUI() {
            players.forEach((p, i) => {
                for(let tNum = 0; tNum < (p.tokenCount||1); tNum++) {
                    const t = document.getElementById(`token-${i}-${tNum}`);
                    const box = document.getElementById(`box-${p.positions[tNum]}`);
                    if (box && t) {
                        t.style.left = (box.offsetLeft + 5 + (i*4) + (tNum*2)) + "px";
                        t.style.top = (box.offsetTop + 5 + (tNum*2)) + "px";
                        if(p.positions[tNum] === 200) t.style.opacity = "0.5";
                    }
                }
            });
        }

        function playSound(n) { if(sfxOn && soundEffects[n]) { soundEffects[n].currentTime = 0; soundEffects[n].play().catch(()=>{}); }}
        
        function doWin(n) { 
            playSound('win'); 
            const overlay = document.getElementById('win-overlay');
            document.getElementById('win-msg').innerText = n.toUpperCase() + " WON!";
            
            if(n === userProfileData.name) {
                userProfileData.totalWins = (userProfileData.totalWins || 0) + 1;
                const winEntry = {
                    opponent: players.find(p => p.name !== userProfileData.name).name,
                    date: new Date().toLocaleDateString(),
                    timestamp: Date.now()
                };
                if(!userProfileData.winHistory) userProfileData.winHistory = [];
                userProfileData.winHistory.unshift(winEntry);
                
                if(isGlobalMatch) {
                    let reward = selectedBet * 2;
                    userProfileData.coins += reward;
                }
                saveProfile();
            }

            if(isGlobalMatch && n === userProfileData.name) {
                let reward = selectedBet * 2;
                document.getElementById('win-sub').innerText = `Victory! You won ${reward} coins!`;
            } else {
                document.getElementById('win-sub').innerText = "All tokens reached the destination!";
            }
            
            overlay.style.display = 'flex'; 

            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            for(let i=0; i<100; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)];
                conf.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(conf);
            }

            // Firework & Racket Animation
            const fwContainer = document.getElementById('fireworks-container');
            const racket = document.getElementById('racket-icon');
            racket.style.display = 'block';
            racket.classList.add('racket-anim');
            
            let fwCount = 0;
            const fwInterval = setInterval(() => {
                if(fwCount >= 10) { clearInterval(fwInterval); return; }
                const fw = document.createElement('div');
                fw.className = 'firework';
                fw.style.left = Math.random() * 100 + '%';
                fw.style.top = Math.random() * 100 + '%';
                fw.style.backgroundColor = CONFIG.colors[Math.floor(Math.random() * 10)];
                fwContainer.appendChild(fw);
                playSound('firework');
                setTimeout(() => fw.remove(), 1000);
                fwCount++;
            }, 500);
        }
    </script>
</body>
</html>
